generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
}


model User {
  id         String   @id @default(uuid()) @db.Uuid
  email      String   @unique
  phone      String?
  password   String
  location   String?
  firstName  String   @map("first_name")
  middleName String?  @map("middle_name")
  lastName   String   @map("last_name")
  avatarUrl  String?  @map("avatar_url")
  role       Role     @default(USER)

  failedLoginAttempts Int       @default(0)
  accountLockedUntil  DateTime?
  refreshTokens       RefreshToken[]
  lastLoginAttempt    DateTime?

  interests        PropertyInterest[]    @relation("UserInterests")
  sentMessages     ChatMessage[]         @relation("SentMessages")
  receivedMessages ChatMessage[]         @relation("ReceivedMessages")
  purchases        Sale[]                @relation("Purchases")
  sales            Sale[]                @relation("Sales")
  auditLogs        AuditLog[]            @relation("UserAuditLogs")
  propertyViews    PropertyView[]        @relation("UserPropertyViews")
  engagements      PropertyEngagement[]  @relation("UserEngagements")


  items      Item[]

  itemsCreated Item[] @relation("ItemCreatedBy")

  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  passwordResetToken String? @unique
  passwordResetTokenExpiresAt DateTime?

  isEmailVerified     Boolean   @default(false)
  emailVerificationToken String? @unique
  emailVerificationTokenExpiresAt DateTime?
}


enum Role {
  USER
  SELLER
  ADMIN
  SUPER_ADMIN
}

model Item {
  id             String   @id @default(uuid()) @db.Uuid
  title          String
  shortDesc      String
  longDesc       String
  dos            String?
  donts          String?
  price          Float
  location       String
  contactInfo    String?
  status         ItemStatus @default(PENDING)
  isFeatured     Boolean    @default(false)

  
  category       ItemCategory @default(FOR_SALE)

   itemType      ItemType @default(HOUSE)

  bedrooms       Int?       
  bathrooms      Int?       
  sqft           Float?     
  propertyType   String?  

   viewCount            Int      @default(0)
  uniqueViewCount      Int      @default(0)
  interestedCount      Int      @default(0)
  whatsappClickCount   Int      @default(0)
  lastViewedAt         DateTime?

  interests   PropertyInterest[]    @relation("PropertyInterests")
  messages    ChatMessage[]         @relation("PropertyMessages")
  sales       Sale[]                @relation("PropertySales")
  views       PropertyView[]        @relation("PropertyViews")
  engagements PropertyEngagement[]  @relation("PropertyEngagements")


  isDeleted      Boolean    @default(false)
  deletedAt      DateTime?
  deletedBy      String?    @db.Uuid
  deletionReason String?  

  createdBy      String?    @db.Uuid
  createdByUser  User?      @relation("ItemCreatedBy", fields: [createdBy], references: [id])

  
  @@index([isDeleted])


  images         ItemImage[]

  ownerId        String?    @db.Uuid
  owner          User?      @relation(fields: [ownerId], references: [id])

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model ItemImage {
  id        String @id @default(uuid()) @db.Uuid 
  url       String
  order     Int    @default(0)

  itemId    String @db.Uuid
  item      Item   @relation(fields: [itemId], references: [id])
}

enum ItemStatus {
  PENDING
  AVAILABLE
  SOLD
  REJECTED
}

enum ItemCategory {
  FOR_SALE        
  FOR_RENT        
  SHORT_STAY      
}

enum ItemType {
  HOUSE           
  HOUSEHOLD_ITEM  
}

model PropertyView {
  id         String   @id @default(uuid()) @db.Uuid
  propertyId String   @db.Uuid
  userId     String?  @db.Uuid // Null if not logged in
  ipAddress  String?  // Track anonymous users
  userAgent  String?  // Device/browser info
  referrer   String?  // Where they came from
  sessionId  String?  // Group views in same session
  viewedAt   DateTime @default(now())

  // Relations
  property   Item     @relation("PropertyViews", fields: [propertyId], references: [id], onDelete: Cascade)
  user       User?    @relation("UserPropertyViews", fields: [userId], references: [id], onDelete: SetNull)

  @@index([propertyId])
  @@index([userId])
  @@index([ipAddress])
  @@index([viewedAt])
  @@map("property_views")
}

model PropertyEngagement {
  id           String         @id @default(uuid()) @db.Uuid
  propertyId   String         @db.Uuid
  userId       String?        @db.Uuid
  actionType   EngagementType
  metadata     Json?          // Extra context per action type
  createdAt    DateTime       @default(now())

  // Relations
  property     Item           @relation("PropertyEngagements", fields: [propertyId], references: [id], onDelete: Cascade)
  user         User?          @relation("UserEngagements", fields: [userId], references: [id], onDelete: SetNull)

  @@index([propertyId])
  @@index([userId])
  @@index([actionType])
  @@index([createdAt])
  @@map("property_engagements")
}

enum EngagementType {
  CLICKED_INTERESTED    // Clicked "I'm Interested" button
  OPENED_WHATSAPP       // Clicked WhatsApp contact
  CLICKED_PHONE         // Clicked phone number
  VIEWED_IMAGE          // Opened image gallery
  SHARED_PROPERTY       // Shared via social media
  BOOKMARKED            // Saved/favorited
  CLICKED_DIRECTIONS    // Clicked map/directions
  DOWNLOADED_BROCHURE   // Downloaded property info
}

// Add these enums
enum InterestStatus {
  ACTIVE
  PURCHASED
  CANCELLED
  EXPIRED
}

enum MessageType {
  TEXT
  IMAGE
  PAYMENT_PROOF
  SYSTEM
}

enum SaleStatus {
  PENDING
  PAYMENT_SUBMITTED
  CONFIRMED
  DELIVERED
  CANCELLED
  DISPUTED
}

// Add these models
model PropertyInterest {
  id         String         @id @default(uuid()) @db.Uuid
  propertyId String         @db.Uuid
  userId     String         @db.Uuid
  status     InterestStatus @default(ACTIVE)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  property Item @relation("PropertyInterests", fields: [propertyId], references: [id], onDelete: Cascade)
  user     User @relation("UserInterests", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([propertyId, userId])
  @@index([propertyId])
  @@index([userId])
  @@index([status])
  @@map("property_interests")
}

model ChatMessage {
  id            String      @id @default(uuid()) @db.Uuid
  propertyId    String      @db.Uuid
  senderId      String      @db.Uuid
  receiverId    String      @db.Uuid
  message       String      @db.Text
  messageType   MessageType @default(TEXT)
  attachmentUrl String?
  isRead        Boolean     @default(false)
  readAt        DateTime?
  createdAt     DateTime    @default(now())

  property Item @relation("PropertyMessages", fields: [propertyId], references: [id], onDelete: Cascade)
  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
  @@map("chat_messages")
}

model Sale {
  id                 String     @id @default(uuid()) @db.Uuid
  propertyId         String     @db.Uuid
  buyerId            String     @db.Uuid
  sellerId           String     @db.Uuid
  amount             Float
  paymentProofUrl    String?
  companyAccountPaid Boolean    @default(false)
  status             SaleStatus @default(PENDING)
  markedSoldAt       DateTime?
  deliveredAt        DateTime?
  notes              String?    @db.Text
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  property Item @relation("PropertySales", fields: [propertyId], references: [id], onDelete: Cascade)
  buyer    User @relation("Purchases", fields: [buyerId], references: [id], onDelete: Cascade)
  seller   User @relation("Sales", fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([createdAt])
  @@map("sales")
}

model AuditLog {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String?   @db.Uuid
  action     String
  entityType String
  entityId   String?   @db.Uuid
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime  @default(now())

  user User? @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}



