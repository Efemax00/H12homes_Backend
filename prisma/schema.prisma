generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== AUTH & CORE ====================

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model User {
  id         String  @id @default(uuid()) @db.Uuid
  email      String  @unique
  phone      String?
  password   String
  location   String?
  firstName  String  @map("first_name")
  middleName String? @map("middle_name")
  lastName   String  @map("last_name")
  avatarUrl  String? @map("avatar_url")
  role       Role    @default(USER)
  
  // User type flags
  isAgent          Boolean @default(false)
  isInventor       Boolean @default(false)
  isFurnitureMaker Boolean @default(false)

  ownedProperties Item[] @relation("OwnerRelation")
  agentListings   Item[] @relation("AgentRelation")

  receiptProofsAsBuyer    ReceiptProof[]   @relation("ReceiptBuyer")
  receiptProofsAsReviewer ReceiptProof[]   @relation("ReceiptReviewer")
  termsAgreements         TermsAgreement[]

  failedLoginAttempts Int            @default(0)
  accountLockedUntil  DateTime?
  refreshTokens       RefreshToken[]
  lastLoginAttempt    DateTime?

  interests        PropertyInterest[]   @relation("UserInterests")
  sentOldMessages  PropertyChatMessage[] @relation("SentMessages")
  receivedMessages PropertyChatMessage[] @relation("ReceivedMessages")
  purchases        Sale[]               @relation("Purchases")
  sales            Sale[]               @relation("Sales")
  auditLogs        AuditLog[]           @relation("UserAuditLogs")
  propertyViews    PropertyView[]       @relation("UserPropertyViews")
  engagements      PropertyEngagement[] @relation("UserEngagements")

  itemsCreated Item[] @relation("ItemCreatedBy")

  payments             Payment[]
  adminCommissions     Commission[] @relation("AdminCommissions")
  financeReviewedSales Sale[]       @relation("FinanceReviewedSales")

  viewingFeePayments ViewingFeePayment[] @relation("UserViewingFees")
  
  // Virtual Assistant Chat
  virtualAssistantChats VirtualAssistantChat[] @relation("UserVAChats")
  
  // Household items
  householdItemsSold      HouseholdItem[] @relation("HouseholdItemSeller")
  householdItemsPurchased HouseholdItemOrder[] @relation("HouseholdItemBuyer")
  householdItemsCreated   HouseholdItem[] @relation("HouseholdItemCreatedBy")
  assignedHouseholdOrders HouseholdItemOrder[] @relation("AssignedAgent")
  
  // Reservation system
  reservedProperties     Item[] @relation("ReservationUser")
  reservationFeePayments ReservationFeePayment[] @relation("ReservationFeePayments")
  
  // Chat System - Real Estate (NEW AI CHAT)
  chatsAsUser              Chat[] @relation("ChatUser")
  chatsAsAgent             Chat[] @relation("ChatAgent")
  chatsClosedByAdmin       Chat[] @relation("ChatClosedByAdmin")
  sentChatMessages         ChatMessage[] @relation("ChatMessageSender")
  reservationFeesConfirmed ReservationFeePayment[] @relation("ReservationFeeConfirmedBy")
  assignedReservationFees  ReservationFeePayment[] @relation("ReservationFeeAgent")
  
  // User ratings & agent stats
  ratingsGiven      UserRating[] @relation("UserGivenRatings")
  ratingsReceived   UserRating[] @relation("UserReceivedRatings")
  agentStats        AgentStatistics? @relation("AgentStats")
  activityLogs      AgentActivityLog[] @relation("AgentActivityLogs")
  reportsFiled      ConversationReport[] @relation("UserReports")
  reportedFor       ConversationReport[] @relation("AgentReportedFor")
  reportsReviewed   ConversationReport[] @relation("AdminReviews")
  agentFeePayments  AgentFeePayment[] @relation("AgentFeePayments")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  passwordResetToken          String? @unique
  passwordResetTokenExpiresAt DateTime?

  isEmailVerified                 Boolean @default(false)
  emailVerificationToken          String? @unique
  emailVerificationTokenExpiresAt DateTime?
}

enum Role {
  USER
  SELLER
  ADMIN
  SUPER_ADMIN
}

// ==================== ITEMS / PROPERTIES ====================

model Item {
  id          String     @id @default(uuid()) @db.Uuid
  title       String
  shortDesc   String
  longDesc    String
  dos         String?
  donts       String?
  price       Float
  location    String
  contactInfo String?
  status      ItemStatus @default(PENDING)
  isFeatured  Boolean    @default(false)

  rentStartDate      DateTime?
  rentEndDate        DateTime?
  rentDurationMonths Int?
  autoReopenAt       DateTime?

  category ItemCategory @default(FOR_SALE)
  itemType ItemType     @default(HOUSE)

  bedrooms     Int?
  bathrooms    Int?
  sqft         Float?
  propertyType String?

  viewCount          Int       @default(0)
  uniqueViewCount    Int       @default(0)
  interestedCount    Int       @default(0)
  whatsappClickCount Int       @default(0)
  lastViewedAt       DateTime?

  interests   PropertyInterest[] @relation("PropertyInterests")
  messages    PropertyChatMessage[] @relation("PropertyMessages")
  sales       Sale[]             @relation("PropertySales")
  views       PropertyView[]     @relation("PropertyViews")
  engagements PropertyEngagement[] @relation("PropertyEngagements")

  agentCommissionPercent   Float @default(0)
  companyCommissionPercent Float @default(0)
  ownerCommissionPercent   Float @default(0)
  platformFeePercent       Float @default(0)

  landlordLinks   PropertyToLandlord[]
  receiptProofs   ReceiptProof[]
  termsAgreements TermsAgreement[]

  ownerId String? @db.Uuid
  owner   User?   @relation("OwnerRelation", fields: [ownerId], references: [id], onDelete: SetNull)

  agentId String? @db.Uuid
  agent   User?   @relation("AgentRelation", fields: [agentId], references: [id], onDelete: SetNull)

  payments           Payment[]
  viewingFeePayments ViewingFeePayment[] @relation("PropertyViewingFees")
  
  // Reservation system
  reservationFeeAmount   Float   @default(10000)
  reservationFeeStatus   ReservationFeeStatus?
  reservationFeePaidAt   DateTime?
  
  currentReservationBy   String? @db.Uuid
  reservationUser        User?   @relation("ReservationUser", fields: [currentReservationBy], references: [id], onDelete: SetNull)
  
  reservationStartedAt   DateTime?
  reservationExpiresAt   DateTime?
  
  reservationRefundedAt  DateTime?
  reservationRefundReason String?
  
  agentViewingScheduledAt DateTime?
  agentViewingCompletedAt DateTime?
  agentViewingApproved    Boolean?
  
  isReserved             Boolean @default(false)
  
  reservationFeePayments ReservationFeePayment[] @relation("PropertyReservationFees")
  
  // AI Chat System
  chats Chat[] @relation("ChatProperty")

  isDeleted      Boolean   @default(false)
  deletedAt      DateTime?
  deletedBy      String?   @db.Uuid
  deletionReason String?

  createdBy     String? @db.Uuid
  createdByUser User?   @relation("ItemCreatedBy", fields: [createdBy], references: [id])

  images ItemImage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isDeleted])
  @@index([itemType])
  @@index([category])
  @@index([currentReservationBy])
  @@index([isReserved])
}

model ItemImage {
  id    String @id @default(uuid()) @db.Uuid
  url   String
  order Int    @default(0)

  itemId String @db.Uuid
  item   Item   @relation(fields: [itemId], references: [id])
}

enum ItemStatus {
  PENDING
  AVAILABLE
  SOLD
  REJECTED
  RENTED
}

enum ItemCategory {
  FOR_SALE
  FOR_RENT
  SHORT_STAY
}

enum ItemType {
  HOUSE
  HOUSEHOLD_ITEM
}

// ==================== HOUSEHOLD ITEMS ====================

model HouseholdItem {
  id          String                @id @default(uuid()) @db.Uuid
  title       String
  description String                @db.Text
  price       Float
  location    String?
  
  type        HouseholdItemType     @default(STOCK)
  status      HouseholdItemStatus   @default(AVAILABLE)
  
  productionDaysMin Int?
  productionDaysMax Int?
  customizationOptions Json?
  
  images      HouseholdItemImage[]
  
  sellerId    String                @db.Uuid
  seller      User                  @relation("HouseholdItemSeller", fields: [sellerId], references: [id], onDelete: Cascade)
  createdBy   String?               @db.Uuid
  createdByUser User?               @relation("HouseholdItemCreatedBy", fields: [createdBy], references: [id])
  
  virtualAssistantChats VirtualAssistantChat[] @relation("ItemVAChats")
  
  orders      HouseholdItemOrder[]  @relation("ItemOrders")
  
  viewCount   Int                   @default(0)
  
  isDeleted   Boolean               @default(false)
  deletedAt   DateTime?
  
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  
  @@index([type])
  @@index([status])
  @@index([sellerId])
  @@index([isDeleted])
}

enum HouseholdItemType {
  STOCK
  CUSTOM
}

enum HouseholdItemStatus {
  AVAILABLE
  DELISTED
  ARCHIVED
}

model HouseholdItemImage {
  id          String              @id @default(uuid()) @db.Uuid
  url         String
  order       Int                 @default(0)
  itemId      String              @db.Uuid
  item        HouseholdItem       @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  @@index([itemId])
}

model HouseholdItemOrder {
  id                String                  @id @default(uuid()) @db.Uuid
  
  itemId            String                  @db.Uuid
  item              HouseholdItem           @relation("ItemOrders", fields: [itemId], references: [id], onDelete: Cascade)
  
  buyerId           String                  @db.Uuid
  buyer             User                    @relation("HouseholdItemBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
  
  sellerId          String                  @db.Uuid
  
  assignedAgentId   String?                 @db.Uuid
  assignedAgent     User?                   @relation("AssignedAgent", fields: [assignedAgentId], references: [id], onDelete: SetNull)
  
  amount            Float
  
  payments          HouseholdItemPayment[]
  
  customizations    Json?
  
  status            HouseholdItemOrderStatus @default(PAYMENT_PENDING)
  
  paymentStatus     PaymentStatus           @default(PENDING)
  paymentId         String?                 @db.Uuid
  paidAt            DateTime?
  
  productionStatus  CustomProductionStatus? @default(NOT_STARTED)
  productionStartedAt DateTime?
  expectedCompletionDate DateTime?
  
  finalPhotosUrl    String[]
  finalPhotosApprovedAt DateTime?
  finalPhotosApprovalStatus CustomPhotoApprovalStatus?
  finalPhotosRejectionReason String?
  
  deliveryStatus    StockDeliveryStatus?
  verifiedByAgentAt DateTime?
  agentVerificationNotes String?
  
  isItemNew         Boolean?
  refundEligibleUntil DateTime?
  refundRequested   Boolean @default(false)
  refundRequestedAt DateTime?
  refundAmount      Float?
  refundReason      String?
  refundedAt        DateTime?
  refundStatus      RefundStatus?
  
  agentFeeAmount    Float?
  agentFeePaid      Boolean @default(false)
  agentFeePaidAt    DateTime?
  complaintRaised   Boolean @default(false)
  complaintRaisedAt DateTime?
  complaintReason   String?
  
  completedAt       DateTime?
  agentCompletionNotes String?
  
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  
  @@index([itemId])
  @@index([buyerId])
  @@index([status])
  @@index([paymentStatus])
  @@index([productionStatus])
  @@map("household_item_orders")
}

enum HouseholdItemOrderStatus {
  PAYMENT_PENDING
  PAYMENT_CONFIRMED
  AGENT_CONTACTED
  AGENT_MEETING_SCHEDULED
  AGENT_VERIFICATION_PENDING
  PRODUCTION_IN_PROGRESS
  AWAITING_FINAL_PHOTOS
  FINAL_PHOTOS_APPROVED
  AWAITING_DELIVERY
  DELIVERED
  COMPLETED
  CANCELLED
  DISPUTED
  REFUNDED
}

enum CustomProductionStatus {
  NOT_STARTED
  MATERIALS_SOURCING
  FRAME_ASSEMBLY
  UPHOLSTERY_WORK
  QUALITY_CHECK
  FINAL_PHOTOS_READY
  READY_FOR_DELIVERY
}

enum CustomPhotoApprovalStatus {
  PENDING
  APPROVED
  CHANGES_REQUESTED
  CHANGES_COMPLETED
  REJECTED
}

enum StockDeliveryStatus {
  AWAITING_AGENT_VERIFICATION
  AGENT_VERIFIED
  READY_FOR_DELIVERY
  DELIVERED
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
}

// ==================== VIRTUAL ASSISTANT CHAT ====================

model VirtualAssistantChat {
  id              String                        @id @default(uuid()) @db.Uuid
  
  userId          String                        @db.Uuid
  user            User                          @relation("UserVAChats", fields: [userId], references: [id], onDelete: Cascade)
  
  householdItemId String                        @db.Uuid
  householdItem   HouseholdItem                 @relation("ItemVAChats", fields: [householdItemId], references: [id], onDelete: Cascade)
  
  status          VAChatStatus                  @default(ACTIVE)
  
  checkpoint1_ItemTypeUnderstand Boolean        @default(false)
  checkpoint2_PaymentWarning     Boolean        @default(false)
  checkpoint3_H12Liability       Boolean        @default(false)
  checkpoint4_ProcessUnderstand  Boolean        @default(false)
  checkpoint5_FinalConfirm       Boolean        @default(false)
  
  customizations Json?
  totalPrice     Float?
  
  readyForPayment Boolean                       @default(false)
  readyForPaymentAt DateTime?
  
  messages        VAChatMessage[]
  
  createdAt       DateTime                      @default(now())
  updatedAt       DateTime                      @updatedAt
  
  @@index([userId])
  @@index([householdItemId])
  @@index([status])
  @@map("virtual_assistant_chats")
}

enum VAChatStatus {
  ACTIVE
  AWAITING_PAYMENT
  COMPLETED
  ABANDONED
}

enum VAStage {
  POST_PAYMENT_INIT
  POST_PAYMENT_SCHEDULED
}

model VAChatMessage {
  id                String @id @default(uuid()) @db.Uuid
  
  chatId            String @db.Uuid
  chat              VirtualAssistantChat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  
  senderType        VAChatSenderType
  
  message           String @db.Text
  messageType       VAChatMessageType @default(TEXT)
  
  actionRequired    Boolean @default(false)
  actionType        String?
  
  createdAt         DateTime @default(now())
  
  @@index([chatId])
  @@index([createdAt])
  @@map("virtual_assistant_chat_messages")
}

enum VAChatSenderType {
  USER
  VIRTUAL_ASSISTANT
}

enum VAChatMessageType {
  TEXT
  SYSTEM_MESSAGE
  CUSTOMIZATION_OPTIONS
  PAYMENT_CONFIRMATION
  FINAL_CONFIRMATION
}

// ==================== AI RESPONSE LIBRARY ====================

model AIResponse {
  id                String   @id @default(uuid()) @db.Uuid
  
  responseType      String   // "greeting", "question", "explanation", "unlock_prompt"
  content           String   @db.Text
  keyword           String?
  
  propertyType      String?  // "HOUSE", "HOUSEHOLD_ITEM", null (all)
  category          String?  // "FOR_SALE", "FOR_RENT", null (all)
  language          String   @default("en")
  
  isActive          Boolean  @default(true)
  priority          Int      @default(0)
  
  createdBy         String   @db.Uuid
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([responseType])
  @@index([isActive])
  @@map("ai_responses")
}

// ==================== CHAT SYSTEM - REAL ESTATE ====================

enum ChatStatus {
  OPEN
  ACTIVE
  PAYMENT_RECEIVED
  CLOSED
  CANCELLED
}

enum ChatMessageType {
  TEXT
  SYSTEM
  ADMIN_NOTIFICATION
  AGENT_NOTIFICATION
}

enum ChatSenderType {
  USER
  AI_AGENT
  REAL_AGENT
  SYSTEM
}

enum AgentActionType {
  CHAT_ASSIGNED
  MESSAGE_SENT
  MESSAGE_READ
  FIRST_RESPONSE
  CALL_INITIATED
  CALL_ENDED
  PAYMENT_CONFIRMED
  CHAT_CLOSED
}

enum AgentPaymentStatus {
  PENDING
  PAYMENT_RECEIVED
  AGENT_PAID
  CANCELLED
  FAILED
}

enum UserRatingCategory {
  RESPONSIVENESS
  PROFESSIONALISM
  HELPFULNESS
  KNOWLEDGE
  TRUSTWORTHINESS
  OVERALL
}

enum ReportReason {
  UNPROFESSIONAL_CONDUCT
  UNRESPONSIVE
  MISLEADING_INFORMATION
  FRAUD_ATTEMPT
  OTHER
}

model Chat {
  id                        String                @id @default(uuid()) @db.Uuid
  
  userId                    String                @db.Uuid
  user                      User                  @relation("ChatUser", fields: [userId], references: [id], onDelete: Cascade)
  
  agentId                   String?               @db.Uuid
  agent                     User?                 @relation("ChatAgent", fields: [agentId], references: [id], onDelete: SetNull)
  
  propertyId                String                @db.Uuid
  property                  Item                  @relation("ChatProperty", fields: [propertyId], references: [id], onDelete: Cascade) 
  
  status                    ChatStatus            @default(OPEN)
  
  // AI PHASE TRACKING (NEW)
  aiPhaseStartedAt          DateTime?
  aiPhaseEndedAt            DateTime?
  aiUnlockKeywordUsed       String?
  aiConversationCount       Int                   @default(0)
  
  // REAL AGENT PHASE TRACKING (NEW)
  agentPhaseStartedAt       DateTime?
  agentFirstMessageAt       DateTime?
  agentLastMessageAt        DateTime?
  agentMessageCount         Int                   @default(0)
  
  // RESERVATION FEE TRACKING (NEW)
  reservationFeeAmount      Float                 @default(10000)
  reservationFeePaidAt      DateTime?
  reservationExpiresAt      DateTime?
  isReservationExpired      Boolean               @default(false)
  reservationExpiredAt      DateTime?
  
  messages                  ChatMessage[]
  
  createdAt                 DateTime              @default(now())
  firstAgentResponseAt      DateTime?
  lastAgentResponseAt       DateTime?
  agentResponseCount        Int                   @default(0)
  agentFeePayment           AgentFeePayment?      @relation("AgentFeePayment")
  
  userMessageCount          Int                   @default(0)
  lastUserMessageAt         DateTime?
  
  averageResponseTimeMinutes Int?
  wasAgentResponsive        Boolean               @default(false)
  agentMissedFirstResponse  Boolean               @default(false)

  vaStage                   VAStage               @default(POST_PAYMENT_INIT)
  
  paymentReceivedAt         DateTime?
  agentPaymentStatus        AgentPaymentStatus    @default(PENDING)
  
  agentFeeAmount            Float?
  agentFeePercentage        Float?
  agentPaymentAccountDetails Json?
  agentPaidAt               DateTime?
  
  closedAt                  DateTime?
  closedByAdminId           String?               @db.Uuid
  closedByAdmin             User?                 @relation("ChatClosedByAdmin", fields: [closedByAdminId], references: [id])
  closureReason             String?
  
  userRating                UserRating?
  
  reports                   ConversationReport[]
  
  activityLogs              AgentActivityLog[]
  
  // OPPOSITE RELATION FOR ReservationFeePayment (NEW)
  reservationFeePayment     ReservationFeePayment?
  
  updatedAt                 DateTime              @updatedAt
  
  @@index([userId])
  @@index([agentId])
  @@index([propertyId])
  @@index([status])
  @@index([createdAt])
  @@index([paymentReceivedAt])
  @@index([reservationExpiresAt])
  @@map("chats")
}

model ChatMessage {
  id                        String                @id @default(uuid()) @db.Uuid
  
  chatId                    String?               @db.Uuid
  chat                      Chat?                 @relation(fields: [chatId], references: [id], onDelete: Cascade)
  
  // SENDER TYPE (NEW)
  senderType                ChatSenderType        @default(USER)
  
  senderId                  String?               @db.Uuid
  sender                    User?                 @relation("ChatMessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  
  message                   String                @db.Text
  messageType               ChatMessageType       @default(TEXT)
  
  // AI TRACKING (NEW)
  isAiGenerated             Boolean               @default(false)
  aiResponseId              String?
  aiConfidenceScore         Float?
  
  readAt                    DateTime?
  
  metadata                  Json?
  
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @default(now())
  
  @@index([chatId])
  @@index([senderId])
  @@index([senderType])
  @@index([createdAt])
  @@map("chat_messages")
}

model UserRating {
  id                        String                @id @default(uuid()) @db.Uuid
  
  chatId                    String                @db.Uuid @unique
  chat                      Chat                  @relation(fields: [chatId], references: [id], onDelete: Cascade)
  
  userId                    String                @db.Uuid
  user                      User                  @relation("UserGivenRatings", fields: [userId], references: [id], onDelete: Cascade)
  
  agentId                   String                @db.Uuid
  agent                     User                  @relation("UserReceivedRatings", fields: [agentId], references: [id], onDelete: Cascade)
  
  responsivenessRating      Int?
  professionalismRating     Int?
  helpfulnessRating         Int?
  knowledgeRating           Int?
  trustworthinessRating     Int?
  overallRating             Int
  
  reviewText                String?               @db.Text
  
  tipAmount                 Float?
  tipPaid                   Boolean               @default(false)
  tipPaidAt                 DateTime?
  
  adminRequestedRating      Boolean               @default(false)
  adminRequestedAt          DateTime?
  
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  
  @@index([chatId])
  @@index([userId])
  @@index([agentId])
  @@index([overallRating])
  @@map("user_ratings")
}

model AgentStatistics {
  id                        String                @id @default(uuid()) @db.Uuid
  
  agentId                   String                @db.Uuid @unique
  agent                     User                  @relation("AgentStats", fields: [agentId], references: [id], onDelete: Cascade)
  
  totalChatsAssigned        Int                   @default(0)
  totalChatsCompleted       Int                   @default(0)
  totalChatsCancelled       Int                   @default(0)
  
  averageResponseTimeMinutes Int?
  responsesWithin24Hours    Int                   @default(0)
  responsesAfter24Hours     Int                   @default(0)
  
  averageOverallRating      Float?
  averageResponsivenessRating Float?
  averageProfessionalismRating Float?
  averageHelpfulnessRating  Float?
  totalRatingsReceived      Int                   @default(0)
  
  totalEarnings             Float                 @default(0)
  totalTipsEarned           Float                 @default(0)
  
  lastActivityAt            DateTime?
  
  isActive                  Boolean               @default(true)
  isWarned                  Boolean               @default(false)
  banReason                 String?
  bannedAt                  DateTime?
  
  updatedAt                 DateTime              @updatedAt
  
  @@index([agentId])
  @@index([averageOverallRating])
  @@map("agent_statistics")
}

model AgentActivityLog {
  id                        String                @id @default(uuid()) @db.Uuid
  
  chatId                    String                @db.Uuid
  chat                      Chat                  @relation(fields: [chatId], references: [id], onDelete: Cascade)
  
  agentId                   String                @db.Uuid
  agent                     User                  @relation("AgentActivityLogs", fields: [agentId], references: [id], onDelete: Cascade)
  
  actionType                AgentActionType
  
  metadata                  Json?
  
  ipAddress                 String?
  userAgent                 String?
  
  createdAt                 DateTime              @default(now())
  
  @@index([chatId])
  @@index([agentId])
  @@index([actionType])
  @@index([createdAt])
  @@map("agent_activity_logs")
}

model ConversationReport {
  id                        String                @id @default(uuid()) @db.Uuid
  
  chatId                    String                @db.Uuid
  chat                      Chat                  @relation(fields: [chatId], references: [id], onDelete: Cascade)
  
  userId                    String                @db.Uuid
  user                      User                  @relation("UserReports", fields: [userId], references: [id], onDelete: Cascade)
  
  reportedAgentId           String                @db.Uuid
  reportedAgent             User                  @relation("AgentReportedFor", fields: [reportedAgentId], references: [id])
  
  reason                    ReportReason
  description               String                @db.Text
  
  reviewedByAdminId         String?               @db.Uuid
  reviewedByAdmin           User?                 @relation("AdminReviews", fields: [reviewedByAdminId], references: [id])
  reviewedAt                DateTime?
  adminNotes                String?
  actionTaken               String?
  
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  
  @@index([chatId])
  @@index([userId])
  @@index([reportedAgentId])
  @@map("conversation_reports")
}

model AgentFeePayment {
  id                        String                @id @default(uuid()) @db.Uuid
  
  chatId                    String                @db.Uuid @unique
  chat                      Chat                  @relation("AgentFeePayment", fields: [chatId], references: [id], onDelete: Cascade)
  agentId                   String                @db.Uuid  
  agent                     User                  @relation("AgentFeePayments", fields: [agentId], references: [id], onDelete: Cascade)
  
  amount                    Float
  percentage                Float
  
  bankName                  String
  accountNumber             String
  accountName               String
  
  status                    AgentPaymentStatus    @default(PENDING)
  
  userPaymentConfirmedAt    DateTime?
  agentPaymentConfirmedAt   DateTime?
  
  metadata                  Json?
  
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  
  @@index([chatId])
  @@index([agentId])
  @@index([status])
  @@map("agent_fee_payments")
}

// ==================== ANALYTICS / ENGAGEMENT ====================

model PropertyView {
  id         String   @id @default(uuid()) @db.Uuid
  propertyId String   @db.Uuid
  userId     String?  @db.Uuid
  ipAddress  String?
  userAgent  String?
  referrer   String?
  sessionId  String?
  viewedAt   DateTime @default(now())

  property Item  @relation("PropertyViews", fields: [propertyId], references: [id], onDelete: Cascade)
  user     User? @relation("UserPropertyViews", fields: [userId], references: [id], onDelete: SetNull)

  @@index([propertyId])
  @@index([userId])
  @@index([ipAddress])
  @@index([viewedAt])
  @@map("property_views")
}

model PropertyEngagement {
  id         String         @id @default(uuid()) @db.Uuid
  propertyId String         @db.Uuid
  userId     String?        @db.Uuid
  actionType EngagementType
  metadata   Json?
  createdAt  DateTime       @default(now())

  property Item  @relation("PropertyEngagements", fields: [propertyId], references: [id], onDelete: Cascade)
  user     User? @relation("UserEngagements", fields: [userId], references: [id], onDelete: SetNull)

  @@index([propertyId])
  @@index([userId])
  @@index([actionType])
  @@index([createdAt])
  @@map("property_engagements")
}

enum EngagementType {
  CLICKED_INTERESTED
  OPENED_WHATSAPP
  CLICKED_PHONE
  VIEWED_IMAGE
  SHARED_PROPERTY
  BOOKMARKED
  CLICKED_DIRECTIONS
  DOWNLOADED_BROCHURE
}

// ==================== INTERESTS / MESSAGES ====================

enum InterestStatus {
  ACTIVE
  PURCHASED
  CANCELLED
  EXPIRED
}

enum MessageType {
  TEXT
  IMAGE
  PAYMENT_PROOF
  SYSTEM
}

enum SaleStatus {
  PENDING
  PAYMENT_SUBMITTED
  CONFIRMED
  DELIVERED
  CANCELLED
  DISPUTED
}

model PropertyInterest {
  id         String         @id @default(uuid()) @db.Uuid
  propertyId String         @db.Uuid
  userId     String         @db.Uuid
  status     InterestStatus @default(ACTIVE)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  property Item @relation("PropertyInterests", fields: [propertyId], references: [id], onDelete: Cascade)
  user     User @relation("UserInterests", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([propertyId, userId])
  @@index([propertyId])
  @@index([userId])
  @@index([status])
  @@map("property_interests")
}

// OLD: Simple property interest messages (RENAMED to PropertyChatMessage)
model PropertyChatMessage {
  id            String      @id @default(uuid()) @db.Uuid
  propertyId    String      @db.Uuid
  senderId      String      @db.Uuid
  receiverId    String      @db.Uuid
  message       String      @db.Text
  messageType   MessageType @default(TEXT)
  attachmentUrl String?
  isRead        Boolean     @default(false)
  readAt        DateTime?
  createdAt     DateTime    @default(now())

  property Item @relation("PropertyMessages", fields: [propertyId], references: [id], onDelete: Cascade)
  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
  @@map("property_chat_messages")
}

// ==================== SALES / DEALS / PAYMENTS ====================

model Sale {
  id                 String     @id @default(uuid()) @db.Uuid
  propertyId         String     @db.Uuid
  buyerId            String     @db.Uuid
  sellerId           String     @db.Uuid
  amount             Float
  paymentProofUrl    String?
  companyAccountPaid Boolean    @default(false)
  status             SaleStatus @default(PENDING)
  markedSoldAt       DateTime?
  deliveredAt        DateTime?
  notes              String?    @db.Text

  isRental        Boolean   @default(false)
  rentalMonths    Int?
  rentalStartDate DateTime?
  rentalEndDate   DateTime?

  paymentMethod       PaymentMethod?
  paymentReference    String?
  financeStatus       FinanceStatus  @default(PENDING)
  financeReviewedById String?        @db.Uuid
  financeReviewedBy   User?          @relation("FinanceReviewedSales", fields: [financeReviewedById], references: [id])
  financeReviewedAt   DateTime?
  financeComment      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  property Item @relation("PropertySales", fields: [propertyId], references: [id], onDelete: Cascade)
  buyer    User @relation("Purchases", fields: [buyerId], references: [id], onDelete: Cascade)
  seller   User @relation("Sales", fields: [sellerId], references: [id], onDelete: Cascade)

  payments    Payment[]
  commissions Commission[]

  @@index([propertyId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([createdAt])
  @@map("sales")
}

enum PaymentProvider {
  MANUAL_TRANSFER
  PAYSTACK
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentMethod {
  BANK_TRANSFER
  CASH_DEPOSIT
  CARD
  OTHER
}

enum FinanceStatus {
  PENDING
  CONFIRMED
  REJECTED
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
}

model Payment {
  id         String          @id @default(uuid()) @db.Uuid
  saleId     String          @db.Uuid
  userId     String          @db.Uuid
  propertyId String          @db.Uuid
  provider   PaymentProvider
  status     PaymentStatus   @default(PENDING)
  amount     Float
  currency   String          @default("NGN")
  reference  String?         @unique
  rawData    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sale     Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)
  user     User @relation(fields: [userId], references: [id], onDelete: Cascade)
  property Item @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([userId])
  @@index([propertyId])
  @@index([status])
  @@map("payments")
}

// ==================== VIEWING FEE PAYMENTS ====================

model ViewingFeePayment {
  id                String        @id @default(uuid()) @db.Uuid
  userId            String        @db.Uuid
  propertyId        String        @db.Uuid
  amount            Float
  paystackReference String        @unique
  status            PaymentStatus @default(PENDING)
  paidAt            DateTime?
  
  agentShare        Float
  companyShare      Float
  
  metadata          Json?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user     User @relation("UserViewingFees", fields: [userId], references: [id], onDelete: Cascade)
  property Item @relation("PropertyViewingFees", fields: [propertyId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([propertyId])
  @@index([status])
  @@index([paystackReference])
  @@map("viewing_fee_payments")
}

// ==================== RESERVATION FEE PAYMENTS ====================

model ReservationFeePayment {
  id                String                @id @default(uuid()) @db.Uuid
  
  userId            String                @db.Uuid
  user              User                  @relation("ReservationFeePayments", fields: [userId], references: [id], onDelete: Cascade)
  
  propertyId        String                @db.Uuid
  property          Item                  @relation("PropertyReservationFees", fields: [propertyId], references: [id], onDelete: Cascade)
  
  // CHAT LINK (NEW)
  chatId            String?               @db.Uuid @unique
  chat              Chat?                 @relation(fields: [chatId], references: [id], onDelete: SetNull)
  
  // Agent assignment
  assignedAgentId   String?               @db.Uuid
  assignedAgent     User?                 @relation("ReservationFeeAgent", fields: [assignedAgentId], references: [id], onDelete: SetNull)
  
  // Payment details
  amount            Float                 @default(10000)
  paystackReference String                @unique
  status            PaymentStatus         @default(PENDING)
  paidAt            DateTime?
  
  // 7-DAY COUNTDOWN (NEW)
  expiresAt         DateTime?
  isExpired         Boolean               @default(false)
  expiredAt         DateTime?
  
  // H12 keeps 100%
  h12KeepsAmount    Float                 @default(10000)
  
  // Agent commission (only if deal completes)
  agentCommissionAmount Float?
  agentCommissionPaidAt DateTime?
  
  // ADMIN TRACKING (NEW)
  confirmedByAdminId String?               @db.Uuid
  confirmedByAdmin   User?                 @relation("ReservationFeeConfirmedBy", fields: [confirmedByAdminId], references: [id])
  confirmedAt       DateTime?
  adminNotes        String?
  
  metadata          Json?
  
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  
  @@index([userId])
  @@index([propertyId])
  @@index([chatId])
  @@index([assignedAgentId])
  @@index([status])
  @@index([expiresAt])
  @@map("reservation_fee_payments")
}

enum ReservationFeeStatus {
  PENDING
  PAID
  REFUNDED
}

// ==================== HOUSEHOLD ITEM PAYMENTS ====================

model HouseholdItemPayment {
  id                String                @id @default(uuid()) @db.Uuid
  
  orderId           String                @db.Uuid
  order             HouseholdItemOrder    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  userId            String                @db.Uuid
  amount            Float
  paystackReference String                @unique
  status            PaymentStatus         @default(PENDING)
  paidAt            DateTime?
  
  h12CommissionPercent Float               @default(10)
  h12CommissionAmount  Float
  sellerAmount         Float
  
  metadata          Json?
  
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  
  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@map("household_item_payments")
}

// ==================== COMMISSIONS ====================

model Commission {
  id        String           @id @default(uuid()) @db.Uuid
  saleId    String           @db.Uuid
  adminId   String           @db.Uuid
  amount    Float
  status    CommissionStatus @default(PENDING)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  sale  Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)
  admin User @relation("AdminCommissions", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([adminId])
  @@map("commissions")
}

// ==================== AUDIT ====================

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String?  @db.Uuid
  action     String
  entityType String
  entityId   String?  @db.Uuid
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user User? @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== LANDLORD & VERIFICATION ====================

model Landlord {
  id       String  @id @default(uuid()) @db.Uuid
  fullName String
  phone    String?
  email    String?
  address  String?

  bankName      String?
  accountNumber String?
  accountName   String?

  verificationStatus LandlordVerificationStatus @default(PENDING)
  nationalIdUrl      String?
  utilityBillUrl     String?
  cacDocUrl          String?

  receiptProofs ReceiptProof[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  properties PropertyToLandlord[]
}

enum LandlordVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

model PropertyToLandlord {
  id String @id @default(uuid()) @db.Uuid

  propertyId String @db.Uuid
  landlordId String @db.Uuid

  createdAt DateTime @default(now())

  property Item     @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  landlord Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([landlordId])
}

model ReceiptProof {
  id         String @id @default(uuid()) @db.Uuid
  propertyId String @db.Uuid
  buyerId    String @db.Uuid
  landlordId String @db.Uuid

  receiptUrl String
  amountPaid Float
  paidAt     DateTime

  status        ReceiptStatus @default(PENDING)
  reviewerId    String?       @db.Uuid
  reviewedAt    DateTime?
  reviewComment String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  property Item @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  buyer User @relation("ReceiptBuyer", fields: [buyerId], references: [id], onDelete: Cascade)

  landlord Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  reviewer User? @relation("ReceiptReviewer", fields: [reviewerId], references: [id])

  @@index([propertyId])
  @@index([buyerId])
  @@index([landlordId])
  @@index([status])
}

enum ReceiptStatus {
  PENDING
  APPROVED
  REJECTED
  FRAUD_SUSPECT
}

model TermsAgreement {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @db.Uuid
  propertyId   String?  @db.Uuid
  termsVersion String
  agreedAt     DateTime @default(now())
  ipAddress    String?
  userAgent    String?

  user     User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  property Item? @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  quizSubmissions TermsQuizSubmission[]

  @@index([userId])
  @@index([propertyId])
}

model TermsQuizSubmission {
  id          String   @id @default(uuid()) @db.Uuid
  agreementId String   @db.Uuid
  score       Int
  passed      Boolean
  answers     Json
  submittedAt DateTime @default(now())

  agreement TermsAgreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)
}
